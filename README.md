# vb-code-go

## 1. 汎用圧縮（ファイル圧縮）

| 技術 | 特徴 | 用途 |
| --- | --- | --- |
| gzip | 広く普及、バランス型 | Webコンテンツ、ログ |
| zstd | 高速＋高圧縮率、現在の主流 | Facebook開発、多用途 |
| lz4 | 超高速、圧縮率は控えめ | リアルタイム処理 |
| brotli | 高圧縮率 | Web配信（Google開発） |

## 2. 整数列専用圧縮（VB Codeの仲間）

| 技術 | 特徴 | 主な採用 |
| --- | --- | --- |
| VB Code | シンプル、実装容易 | 教育、軽量システム |
| PForDelta | ブロック単位で高速 | Lucene（過去） |
| SIMD-BP128 | CPU命令で超高速 | 現代の検索エンジン |
| Roaring Bitmap | 集合演算に最適化 | Elasticsearch、Spark |

## 3. 列指向DB専用

| 技術 | 特徴 |
| --- | --- |
| Run-Length Encoding | 連続する同じ値を圧縮 |
| Dictionary Encoding | 文字列を整数IDに変換 |
| Delta Encoding | 差分保存（VB Codeと併用多い） |

---

## 使い分けの指針

| やりたいこと | 推奨技術 |
| --- | --- |
| ファイルを小さくしたい | zstd（現在の王道） |
| Web配信を高速化 | brotli / gzip |
| ログを圧縮 | zstd / lz4 |
| 検索インデックス | Roaring Bitmap |
| 整数列を圧縮（学習用） | VB Code |
| リアルタイム圧縮 | lz4 / snappy |


---

# 全文検索エンジン アーキテクチャ解説

## システム概要

**10,000件の文書から高速検索できる転置インデックス型検索エンジン**

---

## データフロー

```
入力データ
├─ 10000entries.txt (文書メタデータ)
└─ texts/ (10,000個の文書ファイル)
        ↓
    indexer.go
    ・形態素解析
    ・転置インデックス構築
    ・差分圧縮
        ↓
    index.data (7MB)
        ↓
    searcher.go
    ・インデックス読み込み
    ・検索実行
    ・結果表示
        ↓
    検索結果 (数ミリ秒で返答)
```

---

## 核心技術

### 1. 形態素解析 (Kagome)

**役割**: 日本語を単語に分割

| 入力 | 出力 |
|------|------|
| 東京都に行く | [東京, 都, に, 行く] |
| 美味しいラーメン | [美味しい, ラーメン] |

**なぜ必要？**

- 英語: スペースで区切れる
- 日本語: スペースがない → 形態素解析が必須

---

### 2. 転置インデックス

**通常のインデックス** (順方向):

| 文書ID | 内容 |
|--------|------|
| 1 | 東京に行く |
| 2 | 大阪に行く |
| 3 | 東京が好き |

**転置インデックス** (逆方向):

| 単語 | 出現文書 |
|------|----------|
| 東京 | [1, 3] |
| 大阪 | [2] |
| 行く | [1, 2] |

**効果**: 単語 → 文書を一瞬で検索（O(1)）

---

### 3. 差分圧縮 (GapArray)

**圧縮前**:

```
[15271506, 15271510, 15271520, 15271530]
```

**圧縮後** (差分):

```
[15271506, 4, 10, 10]
```

**復元方法** (累積和):

```
15271506
15271506 + 4 = 15271510
15271510 + 10 = 15271520
15271520 + 10 = 15271530
```

**なぜソートが重要？**

| 状態 | データ | 差分 | 圧縮効率 |
|------|--------|------|----------|
| ソート前 | [520, 506, 510] | [520, -14, 4] | ❌ 悪い |
| ソート後 | [506, 510, 520] | [506, 4, 10] | ✅ 良い |

---

## メモリ効率

### 圧縮効果の比較

| 方式 | メモリ使用量 | 削減率 |
|------|--------------|--------|
| 圧縮なし | 約831MB | - |
| 差分圧縮 | 約208MB | **75%削減** |

### メモリ戦略

| フェーズ | 状態 | 理由 |
|----------|------|------|
| ディスク保存 | 圧縮 | ファイルサイズ削減 |
| メモリ保持 | 圧縮 | メモリ使用量削減 |
| 検索実行時 | 展開 | 実際の文書IDが必要 |
| 結果表示後 | 破棄 | メモリ解放 |

---

## 検索速度の秘密

### 線形探索 vs 転置インデックス

| 方式 | 処理 | 計算量 | 時間 |
|------|------|--------|------|
| 線形探索 | 全文書を調べる | O(n) | 数秒〜数十秒 |
| 転置インデックス | インデックスを引く | O(1) | 数ミリ秒 |

### AND検索の効率化

**例**: "東京" AND "ラーメン"

| 状態 | 処理 | 計算量 |
|------|------|--------|
| ソートなし | 全要素を比較 | O(n×m) |
| ソート済み | マージ処理 | O(n+m) |

```
"東京"     → [1, 5, 23, 100, 234, 567]
"ラーメン" → [5, 100, 234, 999]
            ↓ マージ処理
共通        → [5, 100, 234]
```

---

## 処理の流れ

### indexer.go

| ステップ | 処理 | 結果 |
|----------|------|------|
| 1 | タイトル読み込み | 10,000件 |
| 2 | 形態素解析 | 単語に分割 |
| 3 | 転置インデックス構築 | 単語→文書リスト |
| 4 | 重複削除+ソート | ユニークで昇順 |
| 5 | 差分圧縮 | メモリ効率化 |
| 6 | ディスク保存 | index.data (7MB) |

**結果**: 207,918個の単語をインデックス化

### searcher.go

| ステップ | 処理 | データ |
|----------|------|--------|
| 起動 | インデックス読み込み | 207,918語（圧縮状態） |
| 検索 | インデックス引き | 圧縮データ取得 |
| 展開 | 差分を元に戻す | 文書IDリスト |
| 表示 | 上位5件抽出 | タイトル+URL+スニペット |

**スニペット**: 検索語の前後100文字を抽出

---

## スケーラビリティ

### 現在のスペック

| 項目 | 値 |
|------|-----|
| 文書数 | 10,000件 |
| 単語数 | 207,918語 |
| インデックスサイズ | 7MB |
| メモリ使用量 | 約200MB |
| 検索速度 | 数ミリ秒 |

### 100万件に拡張する場合

| 項目 | 10,000件 | 1,000,000件 | 倍率 |
|------|----------|-------------|------|
| 文書数 | 10,000 | 1,000,000 | 100倍 |
| インデックス | 7MB | 700MB | 100倍 |
| メモリ | 200MB | 20GB | 100倍 |
| 検索速度 | 数ミリ秒 | 数ミリ秒 | 変わらず |

**必要な改善**:

1. シャーディング（分散）
2. ディスクベース検索
3. 並列処理
4. 高度な圧縮

